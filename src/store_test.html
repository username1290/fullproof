<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Store test</title>
    <script src="../../closure-library/closure/goog/base.js"></script>
    <script src="../../ydn-base/js/deps.js"></script>
    <script src="../../ydn-db/js/deps.js"></script>
    <script type="text/javascript" src="../src/deps.js"></script>
    <script type="text/javascript" src="normalizer/unicode/normalizer_lowercase.js"></script>
    <script type="text/javascript" src="normalizer/unicode/normalizer_lowercase_nomark.js"></script>
    <script type="text/javascript" src="normalizer/unicode/categ_letters_numbers.js"></script>
    <script type="text/javascript">
        goog.require('fullproof.ResultSet');
        goog.require('ydn.debug');
        goog.require('ydn.db.Storage');
        goog.require('ydn.db.crud.Storage.text');
        goog.require('fullproof.tests');
        goog.require('goog.testing.ContinuationTestCase');
        goog.require('goog.testing.jsunit');
    </script>
    <script type="text/javascript">
        ydn.db.base.USE_HOOK = true;
        ydn.debug.log('ydn.db', 'finest');
    </script>
</head>
<body>
    <script type="text/javascript">
        var reachedFinalContinuation;
        var setUp = function () {
            reachedFinalContinuation = false;

        };
        var test_inject = function() {
            var schema = {
                fullTextIndexes: [{
                    name: 'test',
                    lang: 'en',


                    sources: [
                        {
                            storeName: 'article',
                            keyPath: 'title',
                            weight: 1.0
                        }, {
                            storeName: 'article',
                            keyPath: 'body',
                            weight: 0.5
                        }]
                }],
                stores: [
                    {
                        name: 'article',
                        keyPath: 'title'
                    }]
            };
            var data = {
                title: 't1',
                body: 'This is a test for data injection. Only one entry injected'
            };
            var db = new ydn.db.Storage('test_inject-1', schema);
            var done;
            var read_data, schema, keywords;
            waitForCondition(
                    // Condition
                    function () {
                        return done;
                    },
                    // Continuation
                    function () {
                        var store_names = schema.stores.map(function(x) {return x.name});
                        assertArrayEquals('two object store', ['article', 'test'], store_names);
                        assertObjectEquals('article t1 inserted as it is', data, read_data);
                        assertNotEquals('index t1 exist', 0, keywords.length);
                        reachedFinalContinuation = true;
                        ydn.db.deleteDatabase(db.getName(), db.getType());
                        db.close();
                    },
                    100, // interval
                    1000); // maxTimeout
            db.getSchema(function(x) {
                schema = x;
            });
            db.clear();
            db.put('article', data);
            db.get('article', 't1').addBoth(function(x) {
                read_data = x;
            });
            db.keys('test', 'keyword', ydn.db.KeyRange.only('t1')).addBoth(function(x) {
                keywords = x;
                done = true;
            });
        };

        var testCase = new goog.testing.ContinuationTestCase();
        testCase.autoDiscoverTests();
        G_testRunner.initialize(testCase);
    </script>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ResultSet test</title>
    <script src="../../closure-library/closure/goog/base.js"></script>
    <script type="text/javascript" src="../src/deps.js"></script>
    <script type="text/javascript">
        goog.require('fullproof.ResultSet');
    </script>
</head>
<body>
    <script type="text/javascript">
        goog.require('goog.testing.jsunit');
        function CustomObject(id) {
            if (!(this instanceof CustomObject)) {
                return new CustomObject(id);
            }
            this.id = parseInt(id);
            this.toString = function() {
                return id.toString();
            }
        }
        var COMP = {
            lower_than: function(a,b) {
                return parseInt(a.id) < parseInt(b.id);
            },
            equals: function(a,b) {
                return a.id == b.id;
            }
        };
        var CO = CustomObject;

        function buildResultSetOfCustomObject(size, func) {
            var result=new fullproof.ResultSet(COMP);
            for (var i=0; i<size; ++i) {
                var value = func?func(i):i;
                result.insert(new CustomObject(value));
            }
            return result;
        }

        function verifyResultSetsOfCustomOject(rs1,rs2) {
            var arr1 = (rs1 instanceof fullproof.ResultSet)?rs1.getDataUnsafe():rs1;
            var arr2 = (rs2 instanceof fullproof.ResultSet)?rs2.getDataUnsafe():rs2;
            assertEquals(arr1.length,arr2.length);
            for (var i=0; i<arr1.length && i<arr2.length; ++i) {
                assertEquals(arr1[i].id, arr2[i].id);
            }
        }
        var test_merge = function() {
            var rs = new fullproof.ResultSet();
            rs.insert(1,2,5);
            rs.merge([0,1,3,5,6]);
            assertArrayEquals(rs.getDataUnsafe(), [0,1,2,3,5,6])
        };
        var test_merge_object = function() {
            var rs = new fullproof.ResultSet(COMP);
            rs.insert(CO(1),CO(2),CO(5));
            rs.merge([CO(0),CO(1),CO(3),CO(5),CO(6)]);
            var expected = [CO(0),CO(1),CO(2),CO(3),CO(5),CO(6)];
            var got = rs.getDataUnsafe();
            verifyResultSetsOfCustomOject(rs,expected);
        };
        var test_merge_object_big = function() {
            var rs = buildResultSetOfCustomObject(1000);
            var rs2 = buildResultSetOfCustomObject(1000, function(v) {
                return v + 500;
            });
            var expected = buildResultSetOfCustomObject(1500);
            rs.merge(rs2);
            verifyResultSetsOfCustomOject(rs,expected);
        };
        var test_merge_empty = function() {
            var rs = new fullproof.ResultSet();
            rs.merge([0,1,3,5,6]);
            assertArrayEquals(rs.getDataUnsafe(), [0,1,3,5,6]);

            rs = new fullproof.ResultSet();
            rs.merge([]);
            assertArrayEquals(rs.getDataUnsafe(), []);

            rs = new fullproof.ResultSet();
            rs.insert(1,2,3);
            rs.merge([]);
            assertArrayEquals(rs.getDataUnsafe(), [1,2,3]);
        };
        var test_merge_empty2 = function() {
            var rs = new fullproof.ResultSet();
            var rs2 = new fullproof.ResultSet();
            rs.merge(rs2);
            assertArrayEquals(rs.getDataUnsafe(), []);
            rs.merge([]);
            assertArrayEquals(rs.getDataUnsafe(), []);
        };
        var test_insert = function() {
            var rs = new fullproof.ResultSet();
            for (var i=0; i<10000; i+=2) {
                rs.insert(i);
            }
            var dd = rs.getDataUnsafe();
            assertEquals(dd.length,10000/2);
        };
        var test_insert_objects = function() {
            var rs = new fullproof.ResultSet(COMP);
            rs.insert(CO(1),CO(2),CO(5));
            rs.insert(CO(0),CO(1),CO(3),CO(5),CO(6));
            var expected = [CO(0),CO(1),CO(2),CO(3),CO(5),CO(6)];
            var got = rs.getDataUnsafe();
            verifyResultSetsOfCustomOject(rs,expected);
        };
        var test_intersect = function(){
            var rs = new fullproof.ResultSet();
            rs.insert(1,2,5);
            rs.intersect([0,1,3,5,6]);
            assertArrayEquals(rs.getDataUnsafe(), [1,5])
        };
        var test_intersect_objects = function(){
            var rs = new fullproof.ResultSet(COMP);
            rs.insert(CO(1),CO(2),CO(5));
            var rs2 = new fullproof.ResultSet(COMP);
            rs2.insert(CO(0),CO(1),CO(3),CO(5),CO(6));
            rs.intersect(rs2);
            var expected = [CO(1),CO(5)];
            var got = rs.getDataUnsafe();
            verifyResultSetsOfCustomOject(rs,expected);
        };
        var test_intersect_big = function() {
            var rs = new fullproof.ResultSet();
            for (var i=0; i<10000; i+=2) {
                rs.insert(i);
            }
            var rs2 = new fullproof.ResultSet();
            for (var i=1; i<10000; i+=2) {
                rs2.insert(i);
            }

            rs2.insert(50,100,150,200,250,302);

            rs.intersect(rs2);
            var dd = rs.getDataUnsafe();
            assertArrayEquals(dd, [50,100,150,200,250,302])
        };
        var test_intersect_object_big = function() {
            var rs = buildResultSetOfCustomObject(1000); // [ 0...1000]
            var rs2 = buildResultSetOfCustomObject(1000, function(v) {	return v + 500; }); // [500...1500]
            var expected = buildResultSetOfCustomObject(500, function(v) { return v+500;}); // [500...1000]
            rs.intersect(rs2);
            verifyResultSetsOfCustomOject(rs,expected);
        };
        var test_substract = function(){
            var rs = new fullproof.ResultSet();
            rs.insert(1,2,5);
            rs.substract([0,1,3,5,6]);
            assertArrayEquals(rs.getDataUnsafe(), [2])
        };
        var test_substract_2 = function(){
            var rs = new fullproof.ResultSet();
            rs.insert(1,2,3,4,5);
            rs.substract([0,1,3,5,6]);
            assertArrayEquals(rs.getDataUnsafe(), [2,4])
        };
        var test_substract_objects = function(){
            var rs = new fullproof.ResultSet(COMP);
            rs.insert(CO(0),CO(1),CO(3),CO(5),CO(6));
            var rs2 = new fullproof.ResultSet(COMP);
            rs2.insert(CO(1),CO(2),CO(5));
            rs.substract(rs2);
            var expected = [CO(0),CO(3),CO(6)];
            var got = rs.getDataUnsafe();
            verifyResultSetsOfCustomOject(rs, expected);
        };
        var test_substract_object_big = function() {
            var rs = buildResultSetOfCustomObject(1000); // [ 0...1000]
            var rs2 = buildResultSetOfCustomObject(1000, function(v) {	return v + 500; }); // [500...1500]
            var expected = buildResultSetOfCustomObject(500, function(v) { return v;});; // [0...500]
            rs.substract(rs2);
            verifyResultSetsOfCustomOject(rs,expected);
        };
        var test_substract_empty1 = function(){
            var rs = new fullproof.ResultSet();
            rs.insert(1,2,3,4,5);
            rs.substract([]);
            assertArrayEquals(rs.getDataUnsafe(), [1,2,3,4,5])
        };

        var test_substract_empty2 = function(){
            var rs = new fullproof.ResultSet();
            var rs2 = new fullproof.ResultSet();
            rs2.insert(1,2,3,4,5);
            rs.substract(rs2);
            assertArrayEquals(rs.getDataUnsafe(), [])
        };

        var test_substract_empty3 = function(){
            var rs = new fullproof.ResultSet();
            var rs2 = new fullproof.ResultSet();
            rs.substract(rs2);
            assertArrayEquals(rs.getDataUnsafe(), [])
        };

    </script>
</body>
</html>